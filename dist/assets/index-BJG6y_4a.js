import{i as P,o as m,b as o,w as r,$ as D,H as R,a as e,C as j,y as T,q as y,A as S,c as k,x as V,ar as G,as as Q,e as L,L as Y,f,g as w,t as b,D as H,Y as W,r as X,X as J,bv as Z,F as U,m as ee,aK as te,b4 as se,u as oe,E as K,I as ae,bw as re,ad as ne,J as M}from"./index-BKxaJmes.js";import{_ as le}from"./PagesLayout.vue_vue_type_script_setup_true_lang-BtkvBusr.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as q}from"./cart--_4SzgrE.js";import{c as N}from"./constants-Bu7G09dq.js";import{a as ie}from"./01-DeMBLNXD.js";import"./TopBar8.vue_vue_type_script_setup_true_lang-D157KbNp.js";import"./LogoBox.vue_vue_type_script_setup_true_lang-DtsTVlc2.js";import"./StickyHeader.vue_vue_type_script_setup_true_lang-Bd8hrDfw.js";import"./ProfileDropdown.vue_vue_type_script_setup_true_lang-DwdOghs1.js";import"./DropDown.vue_vue_type_script_setup_true_lang-DCXrtorV.js";import"./change-casing-BoyW-fpY.js";import"./MobileNavbarToggler-CAzdXCW6.js";import"./index-DdoyQ2gK.js";import"./ShopCart.vue_vue_type_script_setup_true_lang-Dp2SNiK4.js";import"./ChoicesSelect.vue_vue_type_script_setup_true_lang-B5ypeToF.js";import"./02-CA1hCPq5.js";import"./04-D66rD-0h.js";import"./Footer1.vue_vue_type_script_setup_true_lang-LkP-8kz3.js";const ue={},me={class:"py-0"},de=e("div",{class:"bg-light p-4 text-center rounded-3"},[e("h1",{class:"m-0"},"Checkout"),e("div",{class:"d-flex justify-content-center"},[e("nav",{"aria-label":"breadcrumb"},[e("ol",{class:"breadcrumb breadcrumb-dots mb-0"},[e("li",{class:"breadcrumb-item"},[e("a",{href:"#"},"Home")]),e("li",{class:"breadcrumb-item"},[e("a",{href:"#"},"Courses")]),e("li",{class:"breadcrumb-item"},[e("a",{href:"#"},"Cart")]),e("li",{class:"breadcrumb-item active","aria-current":"page"},"Checkout")])])])],-1);function _e(B,C){const c=R,d=D,i=j;return m(),P("section",me,[o(i,null,{default:r(()=>[o(d,null,{default:r(()=>[o(c,{cols:"12"},{default:r(()=>[de]),_:1})]),_:1})]),_:1})])}const pe=ce(ue,[["render",_e]]),fe=e("h6",{class:"mb-3"},"Payment Information",-1),he={__name:"PaymentForm",emits:["success","error","confirm"],setup(B,{emit:C}){const c=C,d=T.useToast(),i=q(),l=y("mpesa"),_=y(""),p=y(""),x=y(!1),E=[{value:"mpesa",text:"M-Pesa"},{value:"vodacom",text:"Vodacom"},{value:"airtel",text:"Airtel"},{value:"mtn",text:"MTN"},{value:"card",text:"Card"}],I=S(()=>i.cartItems.reduce((s,t)=>s+(t.final_price||0),0)),A=S(()=>i.cartItems.some(s=>s.final_price>0)),F=S(()=>A.value&&l.value!=="card"),a=async()=>{if(!x.value){x.value=!0;try{if(!i.cartItems.length)throw new Error("Cart is empty");if(I.value===0){c("confirm",{}),d.success("Proceeding to enroll free items");return}if(!l.value)throw new Error("Payment method is required");if(l.value!=="card"&&!_.value)throw new Error("Phone number is required for mobile payments");if(l.value==="card"&&!p.value)throw new Error("Card number is required for card payments");if(_.value&&!_.value.match(/^\+\d{12}$/))throw new Error("Phone number should start with + followed by 12 digits (e.g., +254123456789)");if(p.value&&!p.value.match(/^\d{16}$/))throw new Error("Card number must be 16 digits");c("confirm",{payment_method:l.value,phone_number:_.value||void 0,card_number:p.value||void 0}),d.success("Submitting payment details...")}catch(s){const t=s.message||"Payment form validation failed";c("error",t),d.error(t)}finally{x.value=!1}}};return(s,t)=>{const n=Q,v=G,u=L,h=Y,O=W;return m(),k(O,{class:"border p-4 rounded-3 bg-light",onSubmit:H(a,["prevent"])},{default:r(()=>[fe,A.value?(m(),k(v,{key:0,label:"Payment Method",class:"mb-3"},{default:r(()=>[o(n,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=$=>l.value=$),options:E,required:""},null,8,["modelValue"])]),_:1})):V("",!0),F.value?(m(),k(v,{key:1,label:"Phone Number",class:"mb-3"},{default:r(()=>[o(u,{modelValue:_.value,"onUpdate:modelValue":t[1]||(t[1]=$=>_.value=$),placeholder:"e.g., +254123456789 or +255123456789",required:""},null,8,["modelValue"])]),_:1})):V("",!0),l.value==="card"?(m(),k(v,{key:2,label:"Card Number",class:"mb-3"},{default:r(()=>[o(u,{modelValue:p.value,"onUpdate:modelValue":t[2]||(t[2]=$=>p.value=$),placeholder:"e.g., 1234567890123456",required:""},null,8,["modelValue"])]),_:1})):V("",!0),o(h,{type:"submit",variant:"primary",disabled:x.value||!f(i).cartItems.length},{default:r(()=>[w(b(x.value?"Processing...":"Checkout"),1)]),_:1},8,["disabled"])]),_:1})}}},be=e("h4",{class:"mb-4"},"Order Summary",-1),ve={class:"mb-3"},ge={class:"input-group"},ye=e("hr",null,null,-1),Ce={key:0,class:"text-center"},xe=e("p",{class:"text-muted"},"Your cart is empty.",-1),we=[xe],ke=["src"],Ie={class:"mb-0"},$e={class:"d-flex justify-content-between align-items-center mt-3"},Pe={class:"text-success"},Ve={class:"text-primary-hover"},Se=["onClick"],Ee={key:0},Ae={key:1,class:"list-group list-group-borderless mb-2"},Fe={class:"list-group-item px-0 d-flex justify-content-between"},Ne=e("span",{class:"h6 fw-light mb-0"},"Original Price",-1),Be={class:"h6 fw-light mb-0 fw-bold"},Oe={class:"list-group-item px-0 d-flex justify-content-between"},Te=e("span",{class:"h6 fw-light mb-0"},"Discount",-1),qe={class:"text-danger"},Me={class:"list-group-item px-0 d-flex justify-content-between"},De=e("span",{class:"h5 mb-0"},"Total",-1),Re={class:"h5 mb-0"},Ue={class:"small mb-0 mt-2 text-center"},je=e("strong",null,"Terms of Service",-1),Le={__name:"OrderSummary",setup(B){const C=T.useToast(),c=q(),d=y(""),i=y(""),l=y(!1),_=y(0),p=y(!1),x=ie,E=S(()=>c.cartItems.reduce((s,t)=>s+(parseFloat(t.price)||0),0)),I=S(()=>c.cartItems.reduce((s,t)=>s+(t.final_price||0),0)-_.value),A=S(()=>E.value-I.value+_.value),F=async()=>{p.value=!0,i.value="";try{if(d.value==="DISCOUNT20")_.value=I.value*.2,l.value=!0,C.success("Coupon applied successfully!");else throw new Error("Invalid coupon code")}catch(s){i.value=s.message||"Failed to apply coupon.",C.error(i.value)}finally{p.value=!1}},a=(s,t)=>{console.log("Removing item:",{slug:s,type:t}),c.removeFromCart(s,t)};return(s,t)=>{const n=L,v=Y,u=Z,h=R,O=X("router-link"),$=D,z=J;return m(),k(h,{xl:"4"},{default:r(()=>[o($,{class:"mb-0"},{default:r(()=>[o(h,{md:"6",xl:"12"},{default:r(()=>[o(z,{"no-body":"",class:"card-body shadow p-4 mb-4"},{default:r(()=>[be,e("div",ve,[e("div",ge,[o(n,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=g=>d.value=g),placeholder:"COUPON CODE"},null,8,["modelValue"]),o(v,{type:"button",variant:"primary",onClick:F,disabled:p.value},{default:r(()=>[w(b(p.value?"Applying...":"Apply"),1)]),_:1},8,["disabled"])]),i.value?(m(),k(u,{key:0,class:"text-danger"},{default:r(()=>[w(b(i.value),1)]),_:1})):V("",!0),l.value?(m(),k(u,{key:1,class:"text-success"},{default:r(()=>[w("Coupon applied! Discount: "+b(f(N))+b(_.value),1)]),_:1})):V("",!0)]),ye,f(c).cartItems.length===0?(m(),P("div",Ce,we)):(m(),P(U,{key:1},[(m(!0),P(U,null,ee(f(c).cartItems,(g,ze)=>(m(),k($,{key:`${g.type}-${g.slug}`,class:"g-3 mb-3"},{default:r(()=>[o(h,{sm:"4"},{default:r(()=>[e("img",{class:"rounded",src:g.image||f(x),alt:"item image"},null,8,ke)]),_:2},1024),o(h,{sm:"8"},{default:r(()=>[e("h6",Ie,[o(O,{to:{name:g.type==="course"?"course.detail":"event.detail",params:{slug:g.slug}}},{default:r(()=>[w(b(g.title),1)]),_:2},1032,["to"])]),e("div",$e,[e("span",Pe,b(f(N))+b(g.final_price),1),e("div",Ve,[e("a",{href:"#",class:"text-body me-2",onClick:H(Ge=>a(g.slug,g.type),["prevent"])},[o(f(te),{class:"me-1 mb-1"}),w("Remove ")],8,Se)])])]),_:2},1024)]),_:2},1024))),128)),f(c).cartItems.length>0?(m(),P("hr",Ee)):V("",!0),f(c).cartItems.length>0?(m(),P("ul",Ae,[e("li",Fe,[Ne,e("span",Be,b(f(N))+b(E.value),1)]),e("li",Oe,[Te,e("span",qe,"-"+b(f(N))+b(A.value),1)]),e("li",Me,[De,e("span",Re,b(f(N))+b(I.value),1)])])):V("",!0),e("p",Ue,[w(" By completing your purchase, you agree to these "),o(O,{to:"/terms",class:"text-primary"},{default:r(()=>[je]),_:1})])],64))]),_:1})]),_:1})]),_:1})]),_:1})}}},Ye={class:"pt-5"},He={key:0,class:"alert alert-danger alert-dismissible d-flex justify-content-between align-items-center fade show py-2 pe-2",role:"alert"},Xe={type:"button",class:"btn btn-link mb-0 text-primary-hover text-end","data-bs-dismiss":"alert","aria-label":"Close"},Je=e("h5",{class:"mb-4"},"Checkout Details",-1),Ke={__name:"PageContent",emits:["clear-cart"],setup(B,{emit:C}){const c=C,d=se(),i=T.useToast(),l=q(),_=oe(),p=y(!1);S(()=>l.cartItems.every(a=>a.final_price<=0));const x=S(()=>l.cartItems.reduce((a,s)=>a+(s.final_price||0),0)),E=async a=>{try{if(console.log("Checking enrollment status for items:",a),!Array.isArray(a)||!a.length)return console.log("Empty or invalid cart items, skipping check"),!0;const s=a.filter(n=>n.type==="course").map(n=>n.slug),t=a.filter(n=>n.type==="event").map(n=>n.slug);if(s.length){const v=(await M.get("/courses/enrolled/")).data.map(u=>{var h;return(h=u.course)==null?void 0:h.slug}).filter(Boolean);if(s.some(u=>v.includes(u)))return i.error("One or more courses are already enrolled."),d.push("/courses"),!1}if(t.length){const v=(await M.get("/participants/")).data.map(u=>{var h;return(h=u.event)==null?void 0:h.slug}).filter(Boolean);if(t.some(u=>v.includes(u)))return i.error("One or more events are already registered."),d.push("/events"),!1}return!0}catch(s){return console.error("Failed to check enrollment/registration status:",s),i.error("Failed to verify status. Please try again."),!1}};K(async()=>{if(console.log("Checking initial cart items:",l.cartItems),!Array.isArray(l.cartItems)||!l.cartItems.length){console.log("Cart is empty or invalid, skipping check");return}await E(l.cartItems)||c("clear-cart")}),ae(()=>l.cartItems,async a=>{if(console.log("Cart items changed:",a),!Array.isArray(a)||!a.length){console.log("Cart is empty or invalid, skipping check");return}await E(a)||c("clear-cart")});const I=()=>{l.clearCart(),i.success("Checkout successful!"),d.push({name:"student.dashboard"})},A=a=>{i.error(a)},F=async a=>{var s,t;if(!p.value){p.value=!0;try{for(const n of l.cartItems){const v=n.type==="course"?`/courses/${n.slug}/enroll/`:`/events/${n.slug}/attend/`,u=n.final_price<=0?{}:{payment_method:a.payment_method,phone_number:a.phone_number,card_number:a.card_number};if(n.final_price>0&&!u.payment_method)throw new Error(`Missing payment method for ${n.title}`);await M.post(v,u)}I()}catch(n){console.error("Checkout error:",n),A(((t=(s=n.response)==null?void 0:s.data)==null?void 0:t.detail)||"Checkout failed. Please try again.")}finally{p.value=!1}}};return(a,s)=>{const t=X("router-link"),n=J,v=R,u=D,h=j;return m(),P("section",Ye,[o(h,null,{default:r(()=>[o(u,{class:"g-4 g-sm-5"},{default:r(()=>[o(v,{xl:"8",class:"mb-4 mb-sm-0"},{default:r(()=>[f(_).isAuthenticated?V("",!0):(m(),P("div",He,[e("div",null,[o(f(re),{class:"me-2"}),w(" Already have an account? "),o(t,{to:"/auth/sign-in",class:"text-reset btn-link mb-0 fw-bold"},{default:r(()=>[w("Log in")]),_:1})]),e("button",Xe,[o(f(ne))])])),o(n,{"no-body":"",class:"card-body shadow p-4"},{default:r(()=>[Je,o(he,{"cart-items":f(l).cartItems,"total-amount":x.value,onSuccess:I,onError:A,onConfirm:F},null,8,["cart-items","total-amount"])]),_:1})]),_:1}),o(Le)]),_:1})]),_:1})])}}},ht={__name:"index",setup(B){const C=T.useToast(),c=q(),d=y(!1),i=async()=>{if(!c.isLoading)try{d.value=!0,await c.fetchCartItems()}catch(_){console.error("Failed to fetch cart items:",_),C.error("Failed to load cart items. Please try again.")}finally{d.value=!1}},l=()=>{c.clearCart()};return K(()=>{i()}),(_,p)=>(m(),k(le,null,{default:r(()=>[o(pe),o(Ke,{onClearCart:l})]),_:1}))}};export{ht as default};
